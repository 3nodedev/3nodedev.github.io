var music=new Howl({urls:["pp_music.mp3","pp_music.ogg"],loop:!0,volume:.5}),load=new function(){};load.road={maxHeight:900,zoneSize:250,maxCurve:400,segmentSize:5,segmentPerColor:4,minOpponentDist:50,maxOpponentDist:350},load.levels={test:{name:"Test",background:{x:0,y:903,w:705,h:120},colors:{sky:"#0500f7",ground1:"#439d0e",ground2:"#439d0e",road1:"#666",road2:"#666",border1:"#fff",border2:"#e00"},sprites:[{x:704,y:141,w:127,h:47},{x:831,y:141,w:127,h:47},{x:704,y:188,w:95,h:79},{x:799,y:188,w:95,h:79},{x:894,y:188,w:95,h:79},{x:704,y:267,w:95,h:79},{x:799,y:267,w:95,h:79},{x:895,y:267,w:95,h:79},{x:0,y:421,w:127,h:47},{x:127,y:421,w:127,h:47},{x:0,y:468,w:95,h:79},{x:95,y:468,w:95,h:79},{x:190,y:468,w:95,h:79},{x:0,y:547,w:95,h:79},{x:95,y:547,w:95,h:79},{x:191,y:547,w:95,h:79}],splash:{x:163,y:224,w:116,h:66}},fuji:{name:"Fuji",background:{x:0,y:903,w:705,h:120},colors:{sky:"#06c7ff",ground1:"#439d0e",ground2:"#439d0e",road1:"#555",road2:"#555",border1:"#fff",border2:"#e00"},sprites:[{x:704,y:141,w:127,h:47},{x:831,y:141,w:127,h:47},{x:704,y:188,w:95,h:79},{x:799,y:188,w:95,h:79},{x:894,y:188,w:95,h:79},{x:704,y:267,w:95,h:79},{x:799,y:267,w:95,h:79},{x:895,y:267,w:95,h:79},{x:0,y:421,w:127,h:47},{x:127,y:421,w:127,h:47},{x:0,y:468,w:95,h:79},{x:95,y:468,w:95,h:79},{x:190,y:468,w:95,h:79},{x:0,y:547,w:95,h:79},{x:95,y:547,w:95,h:79},{x:191,y:547,w:95,h:79}],splash:{x:51,y:224,w:116,h:66}},suzaka:{name:"Suzaka",background:{x:524,y:784,w:500,h:120},colors:{sky:"#cee6fd",ground1:"#20364C",ground2:"#20364C",road1:"#222",road2:"#222",border1:"#fff",border2:"#e00"},sprites:[{x:704,y:141,w:127,h:47},{x:831,y:141,w:127,h:47},{x:704,y:188,w:95,h:79},{x:799,y:188,w:95,h:79},{x:894,y:188,w:95,h:79},{x:704,y:267,w:95,h:79},{x:799,y:267,w:95,h:79},{x:895,y:267,w:95,h:79},{x:0,y:421,w:127,h:47},{x:127,y:421,w:127,h:47},{x:0,y:468,w:95,h:79},{x:95,y:468,w:95,h:79},{x:190,y:468,w:95,h:79},{x:0,y:547,w:95,h:79},{x:95,y:547,w:95,h:79},{x:191,y:547,w:95,h:79}],splash:{x:49,y:293,w:116,h:66}},seaside:{name:"Seaside",background:{x:0,y:784,w:373,h:120},colors:{sky:"#cee6fd",ground1:"#7CA575",ground2:"#7CA575",road1:"#555",road2:"#555",border1:"#fff",border2:"#e00"},sprites:[{x:704,y:141,w:127,h:47},{x:831,y:141,w:127,h:47},{x:704,y:188,w:95,h:79},{x:799,y:188,w:95,h:79},{x:894,y:188,w:95,h:79},{x:704,y:267,w:95,h:79},{x:799,y:267,w:95,h:79},{x:895,y:267,w:95,h:79},{x:0,y:421,w:127,h:47},{x:127,y:421,w:127,h:47},{x:0,y:468,w:95,h:79},{x:95,y:468,w:95,h:79},{x:190,y:468,w:95,h:79},{x:0,y:547,w:95,h:79},{x:95,y:547,w:95,h:79},{x:191,y:547,w:95,h:79}],splash:{x:163,y:293,w:116,h:66}}},load.sprites={car:{x:222,y:129,w:69,h:38},carL:[{x:154,y:129,w:68,h:38},{x:78,y:129,w:74,h:38},{x:0,y:129,w:77,h:38}],carR:[{x:292,y:129,w:68,h:38},{x:361,y:129,w:74,h:38},{x:436,y:129,w:77,h:38}],opponent:{x:222,y:91,w:69,h:38},opponentL:[{x:154,y:91,w:68,h:38},{x:78,y:91,w:74,h:38},{x:0,y:91,w:77,h:38}],opponentR:[{x:292,y:91,w:68,h:38},{x:361,y:91,w:74,h:38},{x:436,y:91,w:77,h:38}],logo:{x:320,y:293,w:320,h:240},rock:{x:345,y:9,w:11,h:14},menuBackground:{x:320,y:531,w:320,h:240},levelIntroBackground:{x:689,y:543,w:320,h:240},buttonL:{x:514,y:168,w:4,h:26},buttonM:{x:517,y:168,w:11,h:26},buttonR:{x:528,y:168,w:4,h:26},activeL:{x:512,y:199,w:6,h:30},activeM:{x:517,y:199,w:11,h:30},activeR:{x:528,y:199,w:6,h:30},focusL:{x:512,y:230,w:6,h:30},focusM:{x:517,y:230,w:11,h:30},focusR:{x:528,y:230,w:6,h:30},icons:{},startPost:{x:0,y:645,w:257,h:128}},load.menus={main:{type:"standard",name:"",description:"C 1982 1983 1996 NAMCO LTD.\n    ALL RIGHTS REMOVED",buttons:["polePosition"]},polePosition:{type:"standard",name:"Choose a Track",icon:load.sprites.icons.cup,description:"&#169 1982 1983 NAMCO LTD. ALL RIGHTS REMOVED",buttons:["testStart","fujiStart","suzakaStart","seasideStart"]},testStart:{type:"final",name:"Test",description:"Test Race Track (easy).",gameMode:"testStart"},suzakaStart:{type:"final",name:"Suzaka",description:"Suzaka Race Track (hard).",gameMode:"suzakaStart"},fujiStart:{type:"final",name:"Fuji",description:"Fuji Race Track (medium).",gameMode:"fujiStart"},seasideStart:{type:"final",name:"Seaside",description:"Seaside Race Track (medium).",gameMode:"seasideStart"},wonfujiStart:{type:"standard",name:"You won the race!",buttons:["quit"]},lostfujiStart:{type:"standard",name:"You lost the race...",buttons:["retryFujiStart","quit"]},wonsuzakaStart:{type:"standard",name:"You won the race!",buttons:["quit"]},lostsuzakaStart:{type:"standard",name:"You lost the race...",buttons:["retrySuzakaStart","quit"]},wonseasideStart:{type:"standard",name:"You won the race!",buttons:["quit"]},lostsuzakaStart:{type:"standard",name:"You lost the race...",buttons:["retrySuzakaStart","quit"]},wontestStart:{type:"standard",name:"You won the race!",buttons:["quit"]},losttestStart:{type:"standard",name:"You lost the race...",buttons:["retryTestStart","quit"]},quit:{type:"final",name:"Quit",description:"Quit to main menu"},retryFujiStart:{type:"final",name:"Retry",description:"Retry the same\nrace again.",gameMode:"fujiStart"},retrySuzakaStart:{type:"final",name:"Retry",description:"Retry the same\nrace again.",gameMode:"suzakaStart"},retrySeasideStart:{type:"final",name:"Retry",description:"Retry the same\nrace again.",gameMode:"seasideStart"},retryTestStart:{type:"final",name:"Retry",description:"Retry the same\nrace again.",gameMode:"testStart"}},load.render={width:320,height:240,depthOfField:175,camera_distance:30,camera_height:75};var logic=function(){};!function(){var e,t,a,o,r,i,n,s,d,l,h;for(t="native",a=Date.now||function(){return(new Date).getTime()},r=window.requestAnimationFrame,l=["webkit","moz","o","ms"],s=0,d=l.length;d>s;s++)n=l[s],null==r&&(r=window[n+"RequestAnimationFrame"]);null==r&&(t="timer",e=0,o=i=null,r=function(t){var r,n,s;return null!=o?void o.push(t):(s=a(),n=Math.max(0,16.66-(s-e)),o=[t],e=s+n,r=function(){var t,a,r,i;for(a=o,o=null,r=0,i=a.length;i>r;r++)(t=a[r])(e)},void(i=setTimeout(r,n)))}),r(function(e){var t;null!=(null!=(t=window.performance)?t.now:void 0)&&1e12>e?(r.now=function(){return window.performance.now()},r.method="native-highres"):r.now=a}),r.now=null!=(null!=(h=window.performance)?h.now:void 0)?function(){return window.performance.now()}:a,r.method=t,window.requestAnimationFrame=r}(),logic.r=function(e){this.m=4294967296,this.a=1103515245,this.c=12345,this.state=e?e:Math.floor(Math.random()*(this.m-1)),this.nextInt=function(){return this.state=(this.a*this.state+this.c)%this.m,this.state},this.nextFloat=function(){return this.nextInt()/(this.m-1)},this.nextRange=function(e,t){var a=t-e,o=this.nextInt()/this.m;return e+Math.floor(o*a)},this.choice=function(e){return e[this.nextRange(0,e.length)]}},logic.parseHash=function(){var e={seed:"0121ZFA0"};return void 0!==window.location.hash&&9===window.location.hash.length&&(e.seed=window.location.hash.slice(1,9)),e.seed},logic.parseSeed=function(e){var t=function(e){var t=e.charCodeAt(0)-48;return t>9&&(t-=7),t},a=["test","fuji","suzaka","seaside"],o={random:36*t(e[0])+t(e[1]),type:a[t(e[2])],length:t(e[3])+1,curvy:t(e[4])/36,mountainy:t(e[5])/36,density:t(e[6])/36,difficulty:t(e[7])};return o.zones=10+o.length,o.numberOfLaps=2,o.numberOfZonesPerLaps=Math.round(o.zones/o.numberOfLaps),o},logic.generateSeed=function(e){},logic.generateNextLapTime=function(e,t){return e.numberOfLaps,Math.round((1-.5*t/e.numberOfLaps)*e.numberOfZonesPerLaps*load.road.zoneSize/(2*e.difficulty))},logic.resize=function(){if($(window).width()/$(window).height()>load.render.width/load.render.height)var e=$(window).height()/load.render.height;else var e=$(window).width()/load.render.width;var t="scale("+e+")";$("#pole_position").css("MozTransform",t).css("transform",t).css("WebkitTransform",t).css({top:(e-1)*load.render.height/2,left:(e-1)*load.render.width/2+($(window).width()-load.render.width*e)/2})},logic.canvasResize=function(){ws={w:$(window).width(),h:$(window).height()};var e=$("#pole_position")[0],t=e.getContext("2d"),a=load.render.width/load.render.height;ws.w/ws.h>a?(e.height=ws.h,e.width=ws.h*a):(e.height=ws.w/a,e.width=ws.w),t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,$("#pole_position").css({top:(ws.h-e.height)/2,left:(ws.w-e.width)/2})},logic.draw={image:function(e,t,a,o,r){e.drawImage(spritesheet,t.x,t.y,t.w,t.h,a,o,r*t.w,r*t.h)},sprite:function(e,t){var a=t.y-t.i.h*t.s;if(t.ymax<t.y)var o=Math.min(t.i.h*(t.ymax-a)/(t.i.h*t.s),t.i.h);else var o=t.i.h;o>0&&e.drawImage(spritesheet,t.i.x,t.i.y,t.i.w,o,t.x,a,t.s*t.i.w,t.s*o)},segment:function(e,t,a,o,r,i,n,s,d,l){var h=d?t.colors.ground2:t.colors.ground1,c=d?t.colors.border2:t.colors.border1,p=d?t.colors.road2:t.colors.road1,u=d?"#fff":t.colors.road1;l&&(p="#fff",u="#fff",c="#fff"),e.fillStyle=h,e.fillRect(0,i,load.render.width,a-i),logic.draw.trapez(e,a,o,r,i,n,s,-.56,.56,p),logic.draw.trapez(e,a,o,r,i,n,s,-.56,-.5,c),logic.draw.trapez(e,a,o,r,i,n,s,.5,.56,c),logic.draw.trapez(e,a,o,r,i,n,s,-.02,-0,u),logic.draw.trapez(e,a,o,r,i,n,s,0,.02,u)},trapez:function(e,t,a,o,r,i,n,s,d,l){var h=load.render.width/2;e.fillStyle=l,e.beginPath(),e.moveTo(h+s*load.render.width*a+o,t),e.lineTo(h+s*load.render.width*i+n,r),e.lineTo(h+d*load.render.width*i+n,r),e.lineTo(h+d*load.render.width*a+o,t),e.fill()},door:function(e,t,a,o){var r=load.render.width/2;e.fillStyle="#FFF",e.beginPath(),e.moveTo(r+(.52+.05*a)*load.render.width*a+o,t),e.lineTo(r+(.52+.05*a)*load.render.width*a+o,t-100*a),e.lineTo(r+.52*load.render.width*a+o,t-100*a),e.lineTo(r+.52*load.render.width*a+o,t),e.moveTo(r-(.52+.05*a)*load.render.width*a+o,t),e.lineTo(r-(.52+.05*a)*load.render.width*a+o,t-100*a),e.lineTo(r-.52*load.render.width*a+o,t-100*a),e.lineTo(r-.52*load.render.width*a+o,t),e.fill(),e.fillStyle="#F00",e.beginPath(),e.moveTo(r+(.52+.05*a)*load.render.width*a+o,t-100*a),e.lineTo(r+(.52+.05*a)*load.render.width*a+o,t-150*a),e.lineTo(r-(.52+.05*a)*load.render.width*a+o,t-150*a),e.lineTo(r-(.52+.05*a)*load.render.width*a+o,t-100*a),e.fill()},background:function(e,t,a,o){e.fillStyle=t.colors.sky,e.fillRect(0,0,load.render.width,o),e.fillStyle=t.colors.ground1,e.fillRect(0,t.background.h+o,load.render.width,load.render.height-t.background.h-o);var r=a/2%t.background.w;logic.draw.image(e,t.background,r-t.background.w+1,o,1),logic.draw.image(e,t.background,r+t.background.w-1,o,1),logic.draw.image(e,t.background,r,o,1)},button:function(e,t,a,o){e.drawImage(spritesheet,load.sprites.buttonL.x,load.sprites.buttonL.y,load.sprites.buttonL.w,load.sprites.buttonL.h,a.x,a.y,load.sprites.buttonL.w,load.sprites.buttonL.h),e.drawImage(spritesheet,load.sprites.buttonM.x,load.sprites.buttonM.y,load.sprites.buttonM.w,load.sprites.buttonM.h,a.x+load.sprites.buttonL.w,a.y,o-load.sprites.buttonL.w-load.sprites.buttonR.w,load.sprites.buttonM.h),e.drawImage(spritesheet,load.sprites.buttonR.x,load.sprites.buttonR.y,load.sprites.buttonR.w,load.sprites.buttonR.h,a.x+o-load.sprites.buttonR.w,a.y,load.sprites.buttonR.w,load.sprites.buttonR.h),1===t?(e.drawImage(spritesheet,load.sprites.focusL.x,load.sprites.focusL.y,load.sprites.focusL.w,load.sprites.focusL.h,a.x-2,a.y-2,load.sprites.focusL.w,load.sprites.focusL.h),e.drawImage(spritesheet,load.sprites.focusM.x,load.sprites.focusM.y,load.sprites.focusM.w,load.sprites.focusM.h,a.x-2+load.sprites.focusL.w,a.y-2,o-load.sprites.focusL.w-load.sprites.focusR.w+4,load.sprites.focusM.h),e.drawImage(spritesheet,load.sprites.focusR.x,load.sprites.focusR.y,load.sprites.focusR.w,load.sprites.focusR.h,a.x+o-load.sprites.focusR.w+2,a.y-2,load.sprites.focusR.w,load.sprites.focusR.h)):2===t&&(e.drawImage(spritesheet,load.sprites.activeL.x,load.sprites.activeL.y,load.sprites.activeL.w,load.sprites.activeL.h,a.x-2,a.y-2,load.sprites.activeL.w,load.sprites.activeL.h),e.drawImage(spritesheet,load.sprites.activeM.x,load.sprites.activeM.y,load.sprites.activeM.w,load.sprites.activeM.h,a.x-2+load.sprites.activeL.w,a.y-2,o-load.sprites.activeL.w-load.sprites.activeR.w+4,load.sprites.activeM.h),e.drawImage(spritesheet,load.sprites.activeR.x,load.sprites.activeR.y,load.sprites.activeR.w,load.sprites.activeR.h,a.x+o-load.sprites.activeR.w+2,a.y-2,load.sprites.activeR.w,load.sprites.activeR.h))},string:function(e,t,a,o,r,i){var n=r.x,s=r.y;if(i){for(var d=0,l=0,h=0;h<o.length;h++)"\n"===o[h]?(l>d&&(d=l),l=0):l++;switch(l>d&&(d=l),a){case 0:n=r.x-8*d/2;break;case 1:n=r.x-9*d/2}}var c=n;0==a&&(o=o.toUpperCase());for(var h=0;h<o.length;h++)switch(a){case 0:"\n"===o[h]?(c=n,s+=8):(e.drawImage(t,8*(o.charCodeAt(h)-32),0,8,8,c,s,8,8),c+=8);break;case 1:"\n"===o[h]?(c=n,s+=13):(e.drawImage(t,9*(o.charCodeAt(h)-33),8,9,13,c,s,9,13),c+=9)}}},logic.generateTest=function(e){for(var t=[],a=[],o=new logic.r(e.random),r=0;5>r;){var i=o.nextRange(load.road.minOpponentDist,load.road.maxOpponentDist),n=2*o.nextFloat()-1;a.push({start:i,phase:n}),r+=i}for(var s=0,d=0,l=0,h=0,c=22,p=c*load.road.zoneSize-load.render.depthOfField;c--;){var u,w;switch(s){case 0:u=0;break;case 1:u=load.road.maxHeight*o.nextFloat();break;case 2:u=-load.road.maxHeight*o.nextFloat()}var g;switch(d){case 0:g=0;break;case 1:g=-load.road.maxCurve*w;break;case 2:g=load.road.maxCurve*w}for(var m=0;m<load.road.zoneSize;m++){var f=!1;if(c%11==0&&m==Math.round(load.road.zoneSize/2)&&t.length<p)var f=!0;var x=!1;if(o.nextFloat()<e.density){var y=o.choice(load.levels[e.type].sprites);x={type:y,pos:1.7},o.nextFloat()<.5&&(x.pos=.4*-x.pos)}t.push({height:l+u/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),curve:h+g/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),sprite:x,lap:f})}l+=u,h+=g,s=0,22==c?(d=0,w=1):21==c?(d=1,w=.5):20==c?(d=1,w=.5):19==c?(d=0,w=1):18==c?(d=0,w=1):17==c?(d=1,w=.5):16==c?(d=1,w=.5):15==c?(d=0,w=1):14==c?(d=0,w=1):13==c?(d=1,w=.5):12==c?(d=1,w=.5):11==c?(d=0,w=1):10==c?(d=1,w=.5):9==c?(d=1,w=.5):8==c?(d=0,w=1):7==c?(d=0,w=1):6==c?(d=1,w=.5):5==c?(d=1,w=.5):4==c?(d=0,w=1):3==c?(d=0,w=1):2==c?(d=1,w=.5):1==c?(d=1,w=.5):(d=0,w=1)}return{road:t,opponents:a}},logic.generateFuji=function(e){for(var t=[],a=[],o=new logic.r(e.random),r=0;5>r;){var i=o.nextRange(load.road.minOpponentDist,load.road.maxOpponentDist),n=2*o.nextFloat()-1;a.push({start:i,phase:n}),r+=i}for(var s=0,d=0,l=0,h=0,c=22,p=c*load.road.zoneSize-load.render.depthOfField;c--;){var u,w;switch(s){case 0:u=0;break;case 1:u=load.road.maxHeight*o.nextFloat();break;case 2:u=-load.road.maxHeight*o.nextFloat()}var g;switch(d){case 0:g=0;break;case 1:g=-load.road.maxCurve*w;break;case 2:g=load.road.maxCurve*w}for(var m=0;m<load.road.zoneSize;m++){var f=!1;if(c%11==0&&m==Math.round(load.road.zoneSize/2)&&t.length<p)var f=!0;var x=!1;if(o.nextFloat()<e.density){var y=o.choice(load.levels[e.type].sprites);x={type:y,pos:1.7},o.nextFloat()<.5&&(x.pos=.4*-x.pos)}t.push({height:l+u/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),curve:h+g/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),sprite:x,lap:f})}l+=u,h+=g,s=0,22==c?(d=0,w=1):21==c?(d=2,w=.9):20==c?(d=0,w=1):19==c?(d=1,w=.3):18==c?(d=0,w=1):17==c?(d=2,w=.5):16==c?(d=2,w=.5):15==c?(d=1,w=1):14==c?(d=2,w=.25):13==c?(d=2,w=.25):12==c?(d=0,w=1):11==c?(d=0,w=1):10==c?(d=2,w=.9):9==c?(d=0,w=1):8==c?(d=1,w=.3):7==c?(d=0,w=1):6==c?(d=2,w=.5):5==c?(d=2,w=.5):4==c?(d=1,w=1):3==c?(d=2,w=.25):2==c?(d=2,w=.25):1==c?(d=0,w=1):(d=0,w=1)}return{road:t,opponents:a}},logic.generateSuzaka=function(e){for(var t=[],a=[],o=new logic.r(e.random),r=0;5>r;){var i=o.nextRange(load.road.minOpponentDist,load.road.maxOpponentDist),n=2*o.nextFloat()-1;a.push({start:i,phase:n}),r+=i}for(var s=0,d=0,l=0,h=0,c=44,p=c*load.road.zoneSize-load.render.depthOfField;c--;){var u,w;switch(s){case 0:u=0;break;case 1:u=load.road.maxHeight*o.nextFloat();break;case 2:u=-load.road.maxHeight*o.nextFloat()}var g;switch(d){case 0:g=0;break;case 1:g=-load.road.maxCurve*w;break;case 2:g=load.road.maxCurve*w}for(var m=0;m<load.road.zoneSize;m++){var f=!1;if(c%22==0&&m==Math.round(load.road.zoneSize/2)&&t.length<p)var f=!0;var x=!1;if(o.nextFloat()<e.density){var y=o.choice(load.levels[e.type].sprites);x={type:y,pos:1.7},o.nextFloat()<.5&&(x.pos=.4*-x.pos)}t.push({height:l+u/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),curve:h+g/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),sprite:x,lap:f})}l+=u,h+=g,s=0,44==c?(d=0,w=1):43==c?(d=2,w=.5):42==c?(d=2,w=.9):41==c?(d=1,w=.9):40==c?(d=2,w=.9):39==c?(d=1,w=.9):38==c?(d=2,w=.9):37==c?(d=1,w=.9):36==c?(d=0,w=1):35==c?(d=0,w=1):34==c?(d=2,w=.9):33==c?(d=0,w=.9):32==c?(d=0,w=1):31==c?(d=1,w=.9):30==c?(d=2,w=.9):29==c?(d=1,w=.5):28==c?(d=1,w=.5):27==c?(d=1,w=.5):26==c?(d=0,w=1):25==c?(d=0,w=1):24==c?(d=2,w=.5):23==c?(d=0,w=1):22==c?(d=0,w=1):21==c?(d=2,w=.5):20==c?(d=2,w=.9):19==c?(d=1,w=.9):18==c?(d=2,w=.9):17==c?(d=1,w=.9):16==c?(d=2,w=.9):15==c?(d=1,w=.9):14==c?(d=0,w=1):13==c?(d=0,w=1):12==c?(d=2,w=.9):11==c?(d=0,w=.9):10==c?(d=0,w=1):9==c?(d=1,w=.9):8==c?(d=2,w=.9):7==c?(d=1,w=.5):6==c?(d=1,w=.5):5==c?(d=1,w=.5):4==c?(d=0,w=1):3==c?(d=0,w=1):2==c?(d=2,w=.5):1==c?(d=0,w=1):(d=0,w=1)}return{road:t,opponents:a}},logic.generateSeaside=function(e){for(var t=[],a=[],o=new logic.r(e.random),r=0;5>r;){var i=o.nextRange(load.road.minOpponentDist,load.road.maxOpponentDist),n=2*o.nextFloat()-1;a.push({start:i,phase:n}),r+=i}for(var s=0,d=0,l=0,h=0,c=40,p=c*load.road.zoneSize-load.render.depthOfField;c--;){var u,w;switch(s){case 0:u=0;break;case 1:u=load.road.maxHeight*o.nextFloat();break;case 2:u=-load.road.maxHeight*o.nextFloat()}var g;switch(d){case 0:g=0;break;case 1:g=-load.road.maxCurve*w;break;case 2:g=load.road.maxCurve*w}for(var m=0;m<load.road.zoneSize;m++){var f=!1;if(c%20==0&&m==Math.round(load.road.zoneSize/2)&&t.length<p)var f=!0;var x=!1;if(o.nextFloat()<e.density){var y=o.choice(load.levels[e.type].sprites);x={type:y,pos:1.7},o.nextFloat()<.5&&(x.pos=.4*-x.pos)}t.push({height:l+u/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),curve:h+g/2*(1+Math.sin(m/load.road.zoneSize*Math.PI-Math.PI/2)),sprite:x,lap:f})}l+=u,h+=g,s=0,40==c?(d=2,w=.2):39==c?(d=2,w=.2):38==c?(d=2,w=.2):37==c?(d=2,w=.9):36==c?(d=1,w=.9):35==c?(d=2,w=.9):34==c?(d=1,w=.9):33==c?(d=2,w=.5):32==c?(d=0,w=1):31==c?(d=0,w=1):30==c?(d=0,w=1):29==c?(d=2,w=.9):28==c?(d=1,w=.9):27==c?(d=2,w=.9):26==c?(d=1,w=.9):25==c?(d=2,w=.9):24==c?(d=2,w=.2):23==c?(d=2,w=.2):22==c?(d=1,w=.9):21==c?(d=2,w=.9):20==c?(d=2,w=.2):19==c?(d=2,w=.2):18==c?(d=2,w=.2):17==c?(d=2,w=.9):16==c?(d=1,w=.9):15==c?(d=2,w=.9):14==c?(d=1,w=.9):13==c?(d=2,w=.5):12==c?(d=0,w=1):11==c?(d=0,w=1):10==c?(d=0,w=1):9==c?(d=2,w=.9):8==c?(d=1,w=.9):7==c?(d=2,w=.9):6==c?(d=1,w=.9):5==c?(d=2,w=.9):4==c?(d=2,w=.2):3==c?(d=2,w=.2):2==c?(d=1,w=.9):1==c?(d=2,w=.9):(d=0,w=1)}return{road:t,opponents:a}};var game=function(){var e,t,a,o,r,i,n,s,d,l,h,c,p,u,w=[],g=0,m=[],f="main",x=0,y=!1,v=logic.parseHash(),b=[],S=[],z=!1,M=!1,k=0,F=function(e){h=e,i=requestAnimationFrame.now()},T=function(e){var t;"testStart"===e?(v="1206ZF1Z",u=logic.parseSeed(v),t=logic.generateTest(u)):"fujiStart"===e?(v="1216ZF1X",u=logic.parseSeed(v),t=logic.generateFuji(u)):"suzakaStart"===e?(v="1226ZF2G",u=logic.parseSeed(v),t=logic.generateSuzaka(u)):"seasideStart"===e&&(v="1236ZF1G",u=logic.parseSeed(v),t=logic.generateSeaside(u)),b=t.road,S=t.opponents,z=!1,M=!1,y=!1,k=0,l={position:10,speed:0,acceleration:.05,deceleration:.1,breaking:.6,turning:5,posx:-90,maxSpeed:21,steering:0,immunity:0}},R=function(){r=requestAnimationFrame.now()-i,s=logic.generateNextLapTime(u,k++),d=r,y=!0},I=function(o){window.requestAnimationFrame(I),t.drawImage(a,0,0,e.width,e.height),L[h](o-i,o-n),P[h](o-i,o-n),n=o},L={menu:function(e,t){var a,r=load.menus[f];r.buttons&&(a=r.buttons[x]),logic.draw.image(o,load.sprites.menuBackground,0,0,1),o.font="10px 'Press Start 2P'",o.textAlign="center",o.fillStyle="#FBFBFF",o.fillText(r.name,load.render.width/2,25),load.menus[a]&&load.menus[a].description&&o.fillText(load.menus[a].description,load.render.width/2,load.render.height/1.2);for(var i=40,n=0;n<r.buttons.length;n++){o.font="8px 'Press Start 2P'";var s=r.buttons[n],d=load.menus[s],l=x===n?1:0;switch(d.type){case"standard":logic.draw.image(o,load.sprites.logo,0,0,1),i=160,logic.draw.button(o,l,{x:60,y:i},200),o.fillText(load.menus[s].name,load.render.width/2,i+18);break;case"final":logic.draw.button(o,l,{x:60,y:i},200),o.fillText(load.menus[s].name,load.render.width/2,i+18),i+=40;break;case"multipleChoice":for(var h=0;h<d.choices.length;h++){var c=0;1===l&&h==d.selected?c=1:h===d.active&&(c=2),logic.draw.button(o,c,{x:50+75*h,y:i},70),o.fillText(d.choices[h],55+75*h,i+6)}i+=40}}if(0!==m.length){var l=x===n?1:0;logic.draw.button(o,l,{x:5,y:205},45),o.fillText("Back",30,222)}},splash:function(e,t){logic.draw.image(o,load.levels[u.type].splash,102,62,1),logic.draw.image(o,load.sprites.levelIntroBackground,0,0,1),o.font="10px 'Press Start 2P'",o.fillStyle="#FBFBFF",o.fillText(load.levels[u.type].name,load.render.width/2,30),o.fillText("Race 2 Laps",load.render.width/2,160),o.fillText("Get Ready!",load.render.width/2,180)},race:function(e,t){music.stop();var a={a:load.sprites.car,x:125,y:190};if(l.steering<0){var i=Math.floor(-l.steering/10);a={a:load.sprites.carL[i],x:125+load.sprites.car.w-load.sprites.carL[i].w,y:190}}else if(l.steering>0){var i=Math.floor(l.steering/10);a={a:load.sprites.carR[i],x:125,y:190}}var n,h,c,w,m=[];z!==!1?(n=Math.floor(z/load.road.segmentSize),h=(n-2)%b.length,c=(n-2)*load.road.segmentSize-z,w=z%load.road.segmentSize/load.road.segmentSize):(n=Math.floor(l.position/load.road.segmentSize),h=(n-2)%b.length,c=(n-2)*load.road.segmentSize-l.position,w=l.position%load.road.segmentSize/load.road.segmentSize);var f=b[h],x=Number.POSITIVE_INFINITY,v=0,F=n%(2*load.road.segmentPerColor),T=b[n%b.length].height,I=b[(n+1)%b.length].height,L=load.render.camera_height+T+(I-T)*w,P=f.curve+(b[(h+1)%b.length].curve-f.curve)*w;logic.draw.background(o,load.levels[u.type],-P,10*(I-T)),g=l.posx-2*P;var C=1e4>e-r?(e-r)/1e4*7:7,O=0;y&&(O=C*(e-r)/30);var A=0,q=0;l.immunity>0&&l.immunity--;for(var E=load.render.depthOfField,D=!1;E--;){var j=(h+1)%b.length,$=b[j],_=Math.floor((L-f.height)*load.render.camera_distance/(load.render.camera_distance+c)),H=30/(load.render.camera_distance+c),B=Math.floor((L-$.height)*load.render.camera_distance/(load.render.camera_distance+c+load.road.segmentSize)),Y=30/(load.render.camera_distance+c+load.road.segmentSize),N=Math.min(x,_),Z=H,G=6==h||h==b.length-load.render.depthOfField||f.lap;if(N>B&&logic.draw.segment(o,load.levels[u.type],load.render.height/2+N,Z,f.curve-P-g*Z,load.render.height/2+B,Y,$.curve-P-g*Y,F<load.road.segmentPerColor,G),G&&m.push({door:!0,position:load.render.height/2+N,scale:Z,offset:f.curve-P-g*Z}),z){if(l.position>h*load.road.segmentSize&&l.position<(h+1)*load.road.segmentSize){var V=(l.position-h*load.road.segmentSize)/load.road.segmentSize,Q=_+V*(B-_),U=H+V*(Y-H);m.push({y:load.render.height/2+Q,x:load.render.width/2+(l.posx-2*P-a.a.w/2)*U+f.curve-P-(l.posx-2*P)*U,ymax:load.render.height/2+x,s:.9*U,i:a.a})}}else E>=load.render.depthOfField-3&&(f.lap&&e-d>2e3&&(D=!0),m.push({x:a.x,y:a.y+a.a.h,ymax:load.render.height,s:1,i:a.a})),logic.draw.image(o,a.a,a.x,a.y,1);for(;q<S.length&&S[q].start+A+O<h*load.road.segmentSize;)A+=S[q].start,q++;for(;q<S.length&&S[q].start+A+O<(h+1)*load.road.segmentSize;){var W=113*Math.cos(S[q].phase*Math.PI/2);y&&(W=113*Math.cos(((e-r)/2e3+S[q].phase)*Math.PI/2)),0===l.immunity&&E<load.render.depthOfField-3&&E>load.render.depthOfField-5&&Math.abs(W-g)<load.sprites.car.w-5&&(l.speed*=.5,l.immunity=10);var X=S[q].start+A+O,V=(X-h*load.road.segmentSize)/load.road.segmentSize,Q=_+V*(B-_),U=H+V*(Y-H);m.push({y:load.render.height/2+Q,x:load.render.width/2+(W-load.sprites.opponent.w/2)*U+f.curve-P-(l.posx-2*P)*U,ymax:load.render.height/2+x,s:.9*U,i:load.sprites.opponent}),A+=S[q].start,q++}f.sprite&&m.push({y:load.render.height/2+_,x:load.render.width/2-f.sprite.pos*load.render.width*Z+f.curve-P-(l.posx-2*P)*Z,ymax:load.render.height/2+x,s:3*Z,i:f.sprite.type}),x=N,v=c,h=j,f=$,c+=load.road.segmentSize,F=(F+1)%(2*load.road.segmentPerColor)}for(;sprite=m.pop();)sprite.door?logic.draw.door(o,sprite.position,sprite.scale,sprite.offset):logic.draw.sprite(o,sprite);var J=e-d,K=s-Math.floor(J/1e3),ee=Math.round((J+d-4e3)/10)/100;D!==!1?(s=logic.generateNextLapTime(u,k++)+K,d=requestAnimationFrame.now()-r):!M&&0>K&&(M=!0,p=e),n>=b.length-load.render.depthOfField-1&&z===!1&&(p=e,z=l.position),o.font="10px 'Press Start 2P'",o.fillStyle="#FBFBFF",o.textAlign="left",o.fillText("TOP ",10,20);var te=0;te+=Math.floor(2*n),o.fillText("SCORE "+te,10,40),o.fillStyle="#6BD7A8",o.textAlign="right",o.fillText("LAP "+ee.toFixed(2),load.render.width-10,20);var ae=Math.round(l.speed/l.maxSpeed*300);o.fillText("SPEED "+ae+"mph",load.render.width,40),o.textAlignt="center",o.fillStyle="#FFF56C",4e3>e?1e3>e?o.fillText("4",load.render.width/2,25):2e3>e?o.fillText("3",load.render.width/2,25):3e3>e?o.fillText("2",load.render.width/2,25):o.fillText("1",load.render.width/2,25):(y||R(),M!==!1?(o.fillText("Game Over!",load.render.width/2,25),ee=p):z!==!1?(o.fillText("Finished!",load.render.width/2,25),ee=p):5e3>e?o.fillText("GO",load.render.width/2,25):(o.fillText("TIME",load.render.width/2,20),o.fillText(K,load.render.width/2,40)))}},P={intro:function(e,t){w[32]&&(F("menu"),o.globalAlpha=1)},menu:function(e,t){},splash:function(e,t){e>2e3&&F("race")},race:function(e,t){if(y){var a=t/30;if(M)e-p>2e3&&(f="lost"+c,m=[],F("menu"),x=0);else if(z)l.position+=l.speed*a,e-p>2e3&&(f="won"+c,m=[],F("menu"),x=0);else{var o=-l.deceleration;w[40]?o=-l.breaking:w[38]&&(o=Math.abs(g)>170&&l.speed>5?2*-l.deceleration:l.acceleration),w[37]?(l.steering-=5,l.steering<-29&&(l.steering=-29)):w[39]?(l.steering+=5,l.steering>29&&(l.steering=29)):0!==l.steering&&(Math.abs(l.steering)<8?l.steering=0:l.steering-=8*l.steering/Math.abs(l.steering)),l.speed+=o*a,l.speed=Math.max(l.speed,0),l.speed=Math.min(l.speed,l.maxSpeed);var r=1;l.speed<3&&(r=9-3*l.speed),l.position+=l.speed*a,l.posx+=l.speed*a*Math.sin(Math.PI/180*l.steering)*r}}}},C=function(){e=$("#pole_position")[0],t=e.getContext("2d"),a=document.createElement("canvas"),o=a.getContext("2d"),a.height=load.render.height,a.width=load.render.width,o.imageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,logic.canvasResize(),$(window).resize(logic.canvasResize),$(document).keydown(function(e){w[e.keyCode]=!0}),$(document).keyup(function(e){w[e.keyCode]=!1}),n=requestAnimationFrame.now()};return $(document).keydown(function(e){if("menu"===h){var t=load.menus[f];if(40===e.keyCode)x+=1,0!==m.length?x>t.buttons.length&&(x=0):x>=t.buttons.length&&(x=0);else if(38===e.keyCode)x-=1,0>x&&(x=t.buttons.length-1);else if(37===e.keyCode){var a=load.menus[t.buttons[x]];a.selected-=1,a.selected<0&&(a.selected=a.choices.length-1)}else if(39===e.keyCode){var a=load.menus[t.buttons[x]];a.selected+=1,a.selected>=a.choices.length&&(a.selected=a.choices.length-1)}else if(13===e.keyCode)if(x===t.buttons.length)f=m.pop(),x=0;else{var a=load.menus[t.buttons[x]];switch(a.type){case"standard":m.push(f),f=t.buttons[x],x=0;break;case"multipleChoice":a.active=a.selected;break;case"final":if("quit"===t.buttons[x])f="main",x=0;else{c=load.menus[t.buttons[x]].gameMode;a.active;T(c),F("splash")}}}}}),{start:function(){C(),spritesheet=new Image,spritesheet.onload=function(){window.requestAnimationFrame(I),music.play(),F("menu")},spritesheet.src="spritesheet.complete.png"}}}();$(function(){game.start()});